name: Build H-Side Init Executable

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]

# Top-level permissions: ensure contents (releases) can be created/modified
permissions:
  contents: write
  packages: write

jobs:
  build-exe:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.10.11'

    - name: Download Icon
      run: |
        # 下载图标文件
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/trustedinster/ZASCA/refs/heads/master/static/img/favicon.ico" -OutFile "app_icon.ico"
        echo "图标已下载到 app_icon.ico"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install nuitka requests

    - name: Build executable with Nuitka
      run: |
        python -m nuitka `
          --standalone `
          --onefile `
          --assume-yes-for-downloads `
          --windows-file-description="ZASCA主机端自动化部署程序" `
          --windows-product-name="ZASCA H-Side" `
          --windows-company-name="Supercmd" `
          --windows-file-version=1.0.0 `
          --windows-product-version=1.0.0 `
          --windows-icon-from-ico=app_icon.ico `
          --include-package=requests `
          --windows-uac-admin `
          --output-filename=h_side_init.exe h_side_init.py

    - name: Upload artifact
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
      uses: actions/upload-artifact@v4
      with:
        name: h-side-init-executable
        path: h_side_init.exe

  release:
    needs: build-exe
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    # (Optional) job-level permissions override (keeps least-privilege)
    permissions:
      contents: write
      packages: write

    steps:
    - name: Download compressed artifact if available
      uses: actions/download-artifact@v7
      with:
        name: h-side-init-executable-compressed
        path: .
      continue-on-error: true  # 如果压缩版不可用则尝试下载原始版本

    - name: Download original artifact if compressed not available
      uses: actions/download-artifact@v7
      with:
        name: h-side-init-executable
        path: .
      if: failure()  # 只有在上一步失败时才下载原始版本

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      # If you have a repository secret PAT called RELEASE_PUBLISH_TOKEN, swap the token below:
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        # use the short tag name (e.g. "v1.2.3") instead of the full ref
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false

    - name: Upload Release Asset
      id: upload-release-asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./h_side_init.exe
        asset_name: h_side_init.exe
        asset_content_type: application/vnd.microsoft.portable-executable